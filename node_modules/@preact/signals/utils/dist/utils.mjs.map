{"version":3,"file":"utils.mjs","sources":["../src/index.tsx"],"sourcesContent":["import { ReadonlySignal, Signal } from \"@preact/signals-core\";\nimport { useSignal } from \"@preact/signals\";\nimport { Fragment, createElement, ComponentChildren } from \"preact\";\nimport { useMemo } from \"preact/hooks\";\n\ninterface ShowProps<T = boolean> {\n\twhen: Signal<T> | ReadonlySignal<T> | (() => T);\n\tfallback?: ComponentChildren;\n\tchildren: ComponentChildren | ((value: NonNullable<T>) => ComponentChildren);\n}\n\nconst Item = (props: any) => {\n\treturn typeof props.children === \"function\"\n\t\t? props.children(props.v, props.i)\n\t\t: props.children;\n};\n\nItem.displayName = \"Item\";\n\nexport function Show<T = boolean>(\n\tprops: ShowProps<T>\n): ComponentChildren | null {\n\tconst value =\n\t\ttypeof props.when === \"function\" ? props.when() : props.when.value;\n\tif (!value) return props.fallback || null;\n\treturn <Item v={value} children={props.children} />;\n}\n\nShow.displayName = \"Show\";\n\ninterface ForProps<T> {\n\teach:\n\t\t| Signal<Array<T>>\n\t\t| ReadonlySignal<Array<T>>\n\t\t| (() => Array<T> | Signal<Array<T>> | ReadonlySignal<Array<T>>);\n\tfallback?: ComponentChildren;\n\tchildren: (value: T, index: number) => ComponentChildren;\n}\n\nexport function For<T>(props: ForProps<T>): ComponentChildren | null {\n\tconst cache = useMemo(() => new Map(), []);\n\tconst list = (\n\t\ttypeof props.each === \"function\" ? props.each() : props.each\n\t) as Signal<Array<T>> | Array<T>;\n\n\tconst listValue = list instanceof Signal ? list.value : list;\n\n\tif (!listValue.length) return props.fallback || null;\n\n\tconst removed = new Set(cache.keys());\n\n\tconst items = listValue.map((value, key) => {\n\t\tremoved.delete(value);\n\t\tif (!cache.has(value)) {\n\t\t\tconst result = <Item v={value} i={key} children={props.children} />;\n\t\t\tcache.set(value, result);\n\t\t\treturn result;\n\t\t}\n\t\treturn cache.get(value);\n\t});\n\n\tremoved.forEach(value => {\n\t\tcache.delete(value);\n\t});\n\n\treturn createElement(Fragment, null, items);\n}\n\nFor.displayName = \"For\";\n\nexport function useLiveSignal<T>(value: T): Signal<T> {\n\tconst s = useSignal(value);\n\tif (s.peek() !== value) s.value = value;\n\treturn s;\n}\n\nexport function useSignalRef<T>(value: T): Signal<T> & { current: T } {\n\tconst ref = useSignal(value) as Signal<T> & { current: T };\n\tif (!(\"current\" in ref))\n\t\tObject.defineProperty(ref, \"current\", refSignalProto);\n\treturn ref;\n}\nconst refSignalProto = {\n\tconfigurable: true,\n\tget(this: Signal) {\n\t\treturn this.value;\n\t},\n\tset(this: Signal, v: any) {\n\t\tthis.value = v;\n\t},\n};\n"],"names":["Signal","useSignal","createElement","Fragment","useMemo","Item","props","children","v","i","displayName","Show","value","when","fallback","For","cache","Map","list","each","listValue","length","removed","Set","keys","items","map","key","delete","has","result","set","get","forEach","useLiveSignal","s","peek","useSignalRef","ref","Object","defineProperty","refSignalProto","configurable","this"],"mappings":"iBAWAA,MAAA,8BAAAC,cAAA,0CAAAC,cAAAC,MAAA,2BAAAC,MAAA,eAAA,MAAMC,EAAQC,GACoB,mBAAnBA,EAAMC,SACjBD,EAAMC,SAASD,EAAME,EAAGF,EAAMG,GAC9BH,EAAMC,SAGVF,EAAKK,YAAc,OAEH,SAAAC,EACfL,GAEA,MAAMM,EACiB,mBAAfN,EAAMO,KAAsBP,EAAMO,OAASP,EAAMO,KAAKD,MAC9D,IAAKA,EAAO,OAAON,EAAMQ,UAAY,UACrC,OAAOZ,EAACG,EAAK,CAAAG,EAAGI,EAAOL,SAAUD,EAAMC,UACxC,CAEAI,EAAKD,YAAc,OAWH,SAAAK,EAAOT,GACtB,MAAMU,EAAQZ,EAAQ,IAAM,IAAIa,IAAO,IACjCC,EACiB,mBAAfZ,EAAMa,KAAsBb,EAAMa,OAASb,EAAMa,KAGnDC,EAAYF,aAAgBlB,EAASkB,EAAKN,MAAQM,EAExD,IAAKE,EAAUC,OAAQ,OAAOf,EAAMQ,UAAY,KAEhD,MAAMQ,EAAU,IAAIC,IAAIP,EAAMQ,QAExBC,EAAQL,EAAUM,IAAI,CAACd,EAAOe,KACnCL,EAAQM,OAAOhB,GACf,IAAKI,EAAMa,IAAIjB,GAAQ,CACtB,MAAMkB,EAAS5B,EAACG,EAAK,CAAAG,EAAGI,EAAOH,EAAGkB,EAAKpB,SAAUD,EAAMC,WACvDS,EAAMe,IAAInB,EAAOkB,GACjB,OAAOA,CACR,CACA,OAAOd,EAAMgB,IAAIpB,EAAK,GAGvBU,EAAQW,QAAQrB,IACfI,EAAMY,OAAOhB,KAGd,OAAOV,EAAcC,EAAU,KAAMsB,EACtC,CAEAV,EAAIL,YAAc,MAEF,SAAAwB,EAAiBtB,GAChC,MAAMuB,EAAIlC,UAAUW,GACpB,GAAIuB,EAAEC,SAAWxB,EAAOuB,EAAEvB,MAAQA,EAClC,OAAOuB,CACR,CAEM,SAAUE,EAAgBzB,GAC/B,MAAM0B,EAAMrC,UAAUW,GACtB,KAAM,YAAa0B,GAClBC,OAAOC,eAAeF,EAAK,UAAWG,GACvC,OAAOH,CACR,CACA,MAAMG,EAAiB,CACtBC,cAAc,EACdV,MACC,OAAWW,KAAC/B,KACb,EACAmB,IAAkBvB,GACjBmC,KAAK/B,MAAQJ,CACd,UACAO,SAAAJ,UAAAuB,mBAAAG"}